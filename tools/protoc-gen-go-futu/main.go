package main

import (
	"flag"
	"google.golang.org/protobuf/compiler/protogen"
	"path/filepath"
	"sort"
)

func newFilename(base, fn string) string {
	return filepath.Dir(base) + "/" + fn
}

func newGeneratedFile(plugin *protogen.Plugin, filename string) *protogen.GeneratedFile {
	f := plugin.Files[0]
	fn := filepath.Dir(f.GeneratedFilenamePrefix) + "/" + filename

	g := plugin.NewGeneratedFile(fn, f.GoImportPath)
	g.P(`// Code generated by protoc-gen-go-futu. DO NOT EDIT.`)
	g.P()
	g.P(`package `, f.GoPackageName)
	g.P()

	return g
}

func generateEnumAdapt(plugin *protogen.Plugin, enums []*protogen.Enum) error {
	//
	sort.Slice(enums, func(i, j int) bool {
		return enums[i].GoIdent.GoName < enums[j].GoIdent.GoName
	})

	g := newGeneratedFile(plugin, "adapt_enums.go")

	// generate enums
	g.P(`const (`)
	for _, enum := range enums {
		g.P(`// Enum: `, enum.Desc.Name())
		name := enum.GoIdent.GoName
		for _, v := range enum.Values {
			g.P(v.Desc.Name(), " ", name, "=", v.GoIdent.GoName)
		}
		g.P()
	}
	g.P(`)`)

	return nil
}

func main() {

	var flags flag.FlagSet

	var enums []*protogen.Enum

	protogen.Options{
		ParamFunc: flags.Set,
	}.Run(func(plugin *protogen.Plugin) error {

		for _, f := range plugin.Files {
			if !f.Generate {
				continue
			}

			enums = append(enums, f.Enums...)
		}

		generateEnumAdapt(plugin, enums)

		return nil
	})
}
